<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test fetchApprovedWhatsAppTemplates Query</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f7fa;
            color: #2c3e50;
        }
        
        h1 {
            color: #1976d2;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        h2 {
            color: #2196f3;
            margin-top: 0;
        }
        
        pre {
            background-color: #f8f9fb;
            border-radius: 4px;
            padding: 1rem;
            overflow: auto;
            border: 1px solid #e0e0e0;
        }
        
        button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-right: 0.5rem;
        }
        
        button:hover {
            background-color: #1976d2;
        }
        
        .button-row {
            margin-bottom: 1rem;
        }
        
        .success {
            color: #4caf50;
            font-weight: bold;
        }
        
        .error {
            color: #f44336;
            font-weight: bold;
        }

        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Test fetchApprovedWhatsAppTemplates Query</h1>
    
    <div class="card">
        <h2>Test Configuration</h2>
        <div style="margin-bottom: 1rem;">
            <label for="endpoint">GraphQL Endpoint:</label>
            <input type="text" id="endpoint" value="/graphql.php" style="width: 300px; padding: 8px; margin-left: 0.5rem;">
        </div>
    </div>
    
    <div class="card">
        <h2>Tests</h2>
        <div class="button-row">
            <button id="testFetchApprovedBtn">Test fetchApprovedWhatsAppTemplates</button>
            <button id="testGetUserTemplatesBtn">Test getWhatsAppUserTemplates</button>
            <button id="testTemplateResolverBtn">Test avec le contrôleur</button>
            <button id="testSafeType">Test avec WhatsAppTemplateSafeType</button>
        </div>
        <div id="loader"></div>
        <div style="margin-top: 0.5rem;">
            <h3>Requête:</h3>
            <pre id="queryBox" style="max-height: 200px;">// Requête GraphQL</pre>
            
            <h3>Résultat:</h3>
            <pre id="resultBox" style="max-height: 400px;">// Résultat de la requête</pre>
        </div>
    </div>
    
    <div class="card">
        <h2>Logs</h2>
        <pre id="logBox" style="max-height: 200px;">// Logs d'exécution</pre>
        <button id="clearLogsBtn">Effacer les logs</button>
    </div>
    
    <script>
        // Éléments DOM
        const endpointInput = document.getElementById('endpoint');
        const queryBox = document.getElementById('queryBox');
        const resultBox = document.getElementById('resultBox');
        const logBox = document.getElementById('logBox');
        const loader = document.getElementById('loader');
        
        // Boutons
        const testFetchApprovedBtn = document.getElementById('testFetchApprovedBtn');
        const testGetUserTemplatesBtn = document.getElementById('testGetUserTemplatesBtn');
        const testTemplateResolverBtn = document.getElementById('testTemplateResolverBtn');
        const testSafeTypeBtn = document.getElementById('testSafeType');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        
        // Fonction d'ajout de logs
        function log(message, isError = false) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            logBox.textContent = logBox.textContent + '\n' + logEntry;
            logBox.scrollTop = logBox.scrollHeight;
            
            console.log(message);
        }
        
        // Fonction pour afficher une requête
        function displayQuery(query) {
            queryBox.textContent = query;
        }
        
        // Fonction pour afficher un résultat
        function displayResult(result, isError = false) {
            if (typeof result === 'object') {
                resultBox.textContent = JSON.stringify(result, null, 2);
            } else {
                resultBox.textContent = result;
            }
            
            if (isError) {
                resultBox.classList.add('error');
                resultBox.classList.remove('success');
            } else {
                resultBox.classList.add('success');
                resultBox.classList.remove('error');
            }
        }
        
        // Fonction d'exécution de requête GraphQL
        async function executeGraphQLQuery(query, variables = {}) {
            const endpoint = endpointInput.value;
            
            try {
                loader.style.display = 'block';
                log(`Exécution de la requête sur ${endpoint}...`);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: variables
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.errors) {
                    log(`Erreur GraphQL: ${result.errors[0].message}`, true);
                    displayResult(result, true);
                } else {
                    log(`Requête exécutée avec succès`);
                    displayResult(result);
                }
                
                return result;
            } catch (error) {
                log(`Erreur: ${error.message}`, true);
                displayResult({ error: error.message }, true);
                return { error: error.message };
            } finally {
                loader.style.display = 'none';
            }
        }
        
        // Requête fetchApprovedWhatsAppTemplates
        async function testFetchApprovedWhatsAppTemplates() {
            const query = `
                query {
                    fetchApprovedWhatsAppTemplates {
                        id
                        name
                        category
                        language
                        status
                        description
                        hasMediaHeader
                        headerType
                        bodyVariablesCount
                        hasButtons
                        buttonsCount
                        hasFooter
                    }
                }
            `;
            
            displayQuery(query);
            return await executeGraphQLQuery(query);
        }
        
        // Requête getWhatsAppUserTemplates
        async function testGetWhatsAppUserTemplates() {
            const query = `
                query {
                    getWhatsAppUserTemplates {
                        id
                        template_id
                        name
                        language
                        status
                    }
                }
            `;
            
            displayQuery(query);
            return await executeGraphQLQuery(query);
        }
        
        // Requête avec le contrôleur explicitement
        async function testTemplateResolver() {
            const query = `
                mutation {
                    __typename
                }
            `;
            
            displayQuery("Mutation pour tester le contrôleur (cette requête ne fait rien mais force l'initialisation du contrôleur)");
            return await executeGraphQLQuery(query);
        }
        
        // Requête avec WhatsAppTemplateSafeType
        async function testWithSafeType() {
            const query = `
                query {
                    fetchApprovedWhatsAppTemplates {
                        id
                        name
                        category
                        language
                        status
                        componentsJson
                        description
                        hasMediaHeader
                        headerType
                        bodyVariablesCount
                        hasButtons
                        buttonsCount
                        hasFooter
                        qualityScore
                        headerFormat
                        fullBodyText
                        footerText
                        buttonsDetailsJson
                        rejectionReason
                        usageCount
                        lastUsedAt
                        isPopular
                    }
                }
            `;
            
            displayQuery(query);
            return await executeGraphQLQuery(query);
        }
        
        // Gestionnaires d'événements pour les boutons
        testFetchApprovedBtn.addEventListener('click', () => {
            testFetchApprovedWhatsAppTemplates();
        });
        
        testGetUserTemplatesBtn.addEventListener('click', () => {
            testGetWhatsAppUserTemplates();
        });
        
        testTemplateResolverBtn.addEventListener('click', () => {
            testTemplateResolver();
        });
        
        testSafeTypeBtn.addEventListener('click', () => {
            testWithSafeType();
        });
        
        clearLogsBtn.addEventListener('click', () => {
            logBox.textContent = '// Logs d\'exécution';
        });
        
        // Initialisation
        log('Page chargée, prêt à exécuter les tests');
    </script>
</body>
</html>