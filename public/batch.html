<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traitement par Lot - Segmentation de Numéros de Téléphone</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://unpkg.com/alpinejs@3.12.3" defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      h1 {
        color: #2c3e50;
        text-align: center;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        min-height: 150px;
        font-family: monospace;
      }
      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #2980b9;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .phone-result {
        margin-bottom: 20px;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .phone-result:last-child {
        border-bottom: none;
      }
      .phone-number {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .segment {
        margin-left: 20px;
        margin-bottom: 5px;
      }
      .segment-type {
        font-weight: bold;
        color: #2c3e50;
      }
      .segment-value {
        color: #3498db;
      }
      .error {
        color: #e74c3c;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #e74c3c;
        border-radius: 4px;
        background-color: #fadbd8;
      }
      .examples {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .example {
        cursor: pointer;
        color: #3498db;
      }
      .example:hover {
        text-decoration: underline;
      }
      .summary {
        margin-top: 20px;
        padding: 10px;
        background-color: #eee;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        color: #27ae60;
      }
      .failure {
        color: #e74c3c;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 15px;
        cursor: pointer;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 4px 4px 0 0;
        background-color: #f9f9f9;
        margin-right: 5px;
      }
      .tab.active {
        background-color: #3498db;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .nav {
        margin-bottom: 20px;
      }
      .nav a {
        color: #3498db;
        text-decoration: none;
        margin-right: 15px;
      }
      .nav a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container" x-data="container">
      <div class="nav">
        <a href="index.php">Accueil</a>
        <a href="segment.html">Segmentation Individuelle</a>
        <a href="batch.html">Traitement par Lot</a>
        <a href="sms.html">Envoi de SMS</a>
        <a href="segments.html">Gestion des Segments</a>
        <a href="import.html">Import/Export</a>
      </div>

      <h1>Traitement par Lot - Segmentation de Numéros de Téléphone</h1>

      <div class="tabs">
        <div
          class="tab"
          :class="{ 'active': activeTab === 'segment' }"
          @click="setTab('segment')"
        >
          Segmenter
        </div>
        <div
          class="tab"
          :class="{ 'active': activeTab === 'save' }"
          @click="setTab('save')"
        >
          Segmenter et Enregistrer
        </div>
      </div>

      <div class="tab-content" :class="{ 'active': activeTab === 'segment' }">
        <div class="form-group">
          <label for="phoneNumbers">Numéros de téléphone (un par ligne)</label>
          <textarea
            id="phoneNumbers"
            x-model="phoneNumbers"
            placeholder="Entrez les numéros de téléphone, un par ligne"
          ></textarea>
        </div>

        <button @click="segmentBatch()">Segmenter</button>
      </div>

      <div class="tab-content" :class="{ 'active': activeTab === 'save' }">
        <div class="form-group">
          <label for="phoneNumbersSave"
            >Numéros de téléphone (un par ligne)</label
          >
          <textarea
            id="phoneNumbersSave"
            x-model="phoneNumbers"
            placeholder="Entrez les numéros de téléphone, un par ligne"
          ></textarea>
        </div>

        <button @click="saveBatch()">Segmenter et Enregistrer</button>
      </div>

      <div class="examples">
        <p>Exemple:</p>
        <pre
          class="example"
          @click="phoneNumbers = '+2250777104936\n002250141399354\n0546560953'"
        >
+2250777104936
002250141399354
0546560953</pre
        >
      </div>

      <div id="result" class="result" x-show="!error" style="display: none">
        <!-- Results will be displayed here -->
      </div>

      <div
        class="error"
        x-show="error"
        x-text="error"
        style="display: none"
      ></div>
    </div>

    <script>
      // Client-side logging function
      function logToConsole(level, message, data = null) {
        const timestamp = new Date().toISOString();
        const logEntry = {
          timestamp,
          level,
          message,
          data,
        };

        console[level](`[${timestamp}] ${message}`, data || "");

        // In a production environment, you might want to send logs to the server
        // or store them in localStorage for later analysis
      }

      // Log HTMX events for debugging
      document.addEventListener("alpine:init", () => {
        Alpine.data("container", () => ({
          phoneNumbers: "",
          result: null,
          error: null,
          activeTab: "segment",

          setTab(tab) {
            this.activeTab = tab;
            this.result = null;
            this.error = null;
          },

          segmentBatch() {
            this.error = null;
            const resultDiv = document.getElementById("result");
            resultDiv.style.display = "none";

            const numbers = this.phoneNumbers
              .split("\n")
              .filter((n) => n.trim() !== "");

            logToConsole("info", "Segmenting batch", { count: numbers.length });

            fetch("/api.php?endpoint=batch-segment", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ numbers: numbers }),
            })
              .then((response) => {
                logToConsole("debug", "API Response received", {
                  status: response.status,
                  statusText: response.statusText,
                });

                if (!response.ok) {
                  return response.json().then((data) => {
                    this.error = data.error || "Une erreur est survenue";
                    logToConsole("error", "API Error", {
                      status: response.status,
                      error: data.error,
                    });
                    throw new Error(this.error);
                  });
                }
                return response.json();
              })
              .then((data) => {
                logToConsole("info", "Successfully processed batch", data);
                this.displayResults(data);
              })
              .catch((error) => {
                logToConsole("error", "Fetch error", error);
              });
          },

          saveBatch() {
            this.error = null;
            const resultDiv = document.getElementById("result");
            resultDiv.style.display = "none";

            const numbers = this.phoneNumbers
              .split("\n")
              .filter((n) => n.trim() !== "");

            logToConsole("info", "Saving batch", { count: numbers.length });

            fetch("/api.php?endpoint=batch-phones", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ numbers: numbers }),
            })
              .then((response) => {
                logToConsole("debug", "API Response received", {
                  status: response.status,
                  statusText: response.statusText,
                });

                if (!response.ok) {
                  return response.json().then((data) => {
                    this.error = data.error || "Une erreur est survenue";
                    logToConsole("error", "API Error", {
                      status: response.status,
                      error: data.error,
                    });
                    throw new Error(this.error);
                  });
                }
                return response.json();
              })
              .then((data) => {
                logToConsole("info", "Successfully saved batch", data);
                this.displayResults(data);
              })
              .catch((error) => {
                logToConsole("error", "Fetch error", error);
              });
          },

          displayResults(response) {
            try {
              const resultDiv = document.getElementById("result");
              resultDiv.style.display = "block";

              // Clear previous results
              resultDiv.innerHTML = "";

              // Add summary
              const summaryDiv = document.createElement("div");
              summaryDiv.className = "summary";
              summaryDiv.innerHTML = `
                <div>Total: ${response.summary.total}</div>
                <div class="success">Réussis: ${response.summary.successful}</div>
                <div class="failure">Échoués: ${response.summary.failed}</div>
              `;
              resultDiv.appendChild(summaryDiv);

              // Display successful results
              if (response.results) {
                logToConsole("info", "Processing results", {
                  count: Object.keys(response.results).length,
                });

                Object.keys(response.results).forEach((key) => {
                  const phoneNumber = response.results[key];
                  const phoneDiv = document.createElement("div");
                  phoneDiv.className = "phone-result";

                  // Display the normalized phone number
                  const numberDiv = document.createElement("div");
                  numberDiv.className = "phone-number";
                  numberDiv.textContent = `Numéro: ${
                    phoneNumber.number || "Unknown"
                  }`;
                  phoneDiv.appendChild(numberDiv);

                  // Display each segment
                  if (
                    phoneNumber.technicalSegments &&
                    phoneNumber.technicalSegments.length > 0
                  ) {
                    phoneNumber.technicalSegments.forEach((segment) => {
                      const segmentDiv = document.createElement("div");
                      segmentDiv.className = "segment";

                      let segmentType = segment.segmentType;
                      switch (segment.segmentType) {
                        case "country_code":
                          segmentType = "Code pays";
                          break;
                        case "operator_code":
                          segmentType = "Code opérateur";
                          break;
                        case "subscriber_number":
                          segmentType = "Numéro d'abonné";
                          break;
                        case "operator_name":
                          segmentType = "Opérateur";
                          break;
                      }

                      segmentDiv.innerHTML = `<span class="segment-type">${segmentType}:</span> <span class="segment-value">${segment.value}</span>`;
                      phoneDiv.appendChild(segmentDiv);
                    });
                  } else {
                    logToConsole(
                      "warn",
                      "No segments found for phone number",
                      phoneNumber
                    );
                    const noSegmentsDiv = document.createElement("div");
                    noSegmentsDiv.className = "segment";
                    noSegmentsDiv.textContent =
                      "Aucun segment trouvé pour ce numéro";
                    phoneDiv.appendChild(noSegmentsDiv);
                  }

                  resultDiv.appendChild(phoneDiv);
                });
              } else {
                logToConsole("warn", "No results found in response", response);
              }

              // Display errors
              if (response.errors && Object.keys(response.errors).length > 0) {
                logToConsole(
                  "warn",
                  "Errors found in response",
                  response.errors
                );

                const errorsTitle = document.createElement("h3");
                errorsTitle.textContent = "Erreurs:";
                resultDiv.appendChild(errorsTitle);

                Object.keys(response.errors).forEach((key) => {
                  const error = response.errors[key];
                  const errorDiv = document.createElement("div");
                  errorDiv.className = "error";
                  errorDiv.textContent = `${error.number}: ${error.error}`;
                  resultDiv.appendChild(errorDiv);
                });
              }
            } catch (e) {
              logToConsole("error", "Error processing response", e);
              const resultDiv = document.getElementById("result");
              resultDiv.innerHTML = `<div class="error">Une erreur est survenue lors du traitement de la réponse: ${e.message}</div>`;
            }
          },
        }));
      });
    </script>
  </body>
</html>
